name: dev-tools

ddev_version_constraint: '>= v1.24.3'

project_files:
  - docker-compose.cypress.yaml
  - web-build/Dockerfile
  - commands/host/dev-lint-all
  - commands/host/install-drupal
  - commands/web/dev-crawler
  - commands/web/dev-cspell
  - commands/web/dev-eslint
  - commands/web/dev-lint
  - commands/web/dev-phpcs
  - commands/web/dev-phpstan
  - commands/web/dev-stylelint
  - commands/web/dev-twigcs
  - commands/web/dev-utils.sh
  - commands/web/thin-db-export
  - commands/cypress/cypress-headless
  - commands/cypress/cypress-install
  - commands/cypress/cypress-ui
  - drupal_java_crawler/.gitignore
  - drupal_java_crawler/README.md
  - drupal_java_crawler/pom.xml
  - drupal_java_crawler/src/main/java/org/example/DrupalCrawler.java

post_install_actions:
  - ddev exec composer config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
  - ddev exec composer require --dev drupal/coder:^8.3 dealerdirect/phpcodesniffer-composer-installer squizlabs/php_codesniffer:^3.7
  - ddev exec composer config allow-plugins.vincentlanglet/twig-cs-fixer true
  - ddev exec composer require --dev vincentlanglet/twig-cs-fixer:^3.0
  - ddev exec composer require --dev phpstan/phpstan phpstan/extension-installer mglaman/phpstan-drupal
  - |
    #ddev-description:Compiling Java Crawler
    if [ -d /var/www/html/.ddev/drupal_java_crawler ]; then
      echo "Compiling Drupal Java Crawler..."
      ddev exec "cd /var/www/html/.ddev/drupal_java_crawler && mvn clean compile -q"
      echo "âœ“ Java Crawler compiled successfully!"
    fi
  - |
    if [ -d /var/www/html/docroot/core ]; then
      ddev yarn --cwd /var/www/html/docroot/core/ install
    elif [ -d /var/www/html/web/core ]; then
      ddev yarn --cwd /var/www/html/web/core/ install
    fi
  - |
    #ddev-nodisplay
    #ddev-description:Adding all hostnames to the cypress container to make them available
    cat <<-END >docker-compose.cypress_extras.yaml
    #ddev-generated
    services:
      cypress:
        external_links:
        {{- $cypress_hostnames := splitList "," (env "DDEV_HOSTNAME") -}}
        {{- range $i, $n := $cypress_hostnames }}
          - "ddev-router:{{- replace (env "DDEV_TLD") "\\${DDEV_TLD}" (replace (env "DDEV_PROJECT") "\\${DDEV_PROJECT}" $n) -}}"
        {{- end }}
    END
  - echo "Vardot's DDEV Dev Tools with Cypress support has been installed and configured!"

removal_actions:
  - |
    #ddev-nodisplay
    #ddev-description:Remove docker-compose.cypress_extras.yaml file
    if [ -f docker-compose.cypress_extras.yaml ]; then
      if grep -q '#ddev-generated' docker-compose.cypress_extras.yaml; then
        rm -f docker-compose.cypress_extras.yaml
      else
        echo "Unwilling to remove '$DDEV_APPROOT/.ddev/docker-compose.cypress_extras.yaml' because it does not have #ddev-generated in it; you can manually delete it if it is safe to delete."
      fi
    fi