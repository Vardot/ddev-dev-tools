#!/bin/bash

source "${0%/*}/dev-utils.sh"

## #ddev-generated
## Description: Run PHPStan on PHP files
# Usage: ddev dev-phpstan [--all] [--files=file1.php,file2.module]
# Example: "ddev dev-phpstan" (checks git diff)
#          "ddev dev-phpstan --all" (checks all PHP files)
#          "ddev dev-phpstan --files=file1.php,file2.module" (checks specific files)

set -euo pipefail

# Function to generate phpstan.neon if it doesn't exist
generate_phpstan_config() {
    if [ ! -f "phpstan.neon" ]; then
        echo "ðŸ“ Generating phpstan.neon configuration file..."
        cat > phpstan.neon << 'EOF'
# Configuration file for PHPStan static code checking, see https://phpstan.org .
includes:
  - phar://phpstan.phar/conf/bleedingEdge.neon

parameters:

  level: 2

  paths:
    - docroot/modules/custom
    - docroot/themes/custom

  excludePaths:
    # Skip test fixtures.
    - ../*/node_modules/*
    - */tests/fixtures/*.php
    - */tests/fixtures/*.php.gz

  ignoreErrors:
    # new static() is a best practice in Drupal, so we cannot fix that.
    - "#^Unsafe usage of new static#"

    # Ignore common errors for now.
    - "#Drupal calls should be avoided in classes, use dependency injection instead#"
    - "#^Plugin definitions cannot be altered.#"
    - "#^Missing cache backend declaration for performance.#"
    - "#cache tag might be unclear and does not contain the cache key in it.#"
    - "#^Class .* extends @internal class#"
EOF
        echo "âœ… Created phpstan.neon configuration file"
    fi
}

# Generate phpstan.neon if it doesn't exist
generate_phpstan_config

# Define extensions for PHP files
EXTENSIONS=("php" "module")

# Get files based on extensions and arguments
if [ $# -eq 0 ]; then
    # No arguments - use git diff
    FILES=$(get_files "${EXTENSIONS[@]}")
else
    # Pass all arguments to get_files along with extensions
    FILES=$(get_files "${EXTENSIONS[@]}" "$@")
fi

if [ -z "${FILES:-}" ]; then
    echo "âœ… No PHP files to check"
    exit 0
fi

echo "ðŸ” Running PHPStan on files:"
echo "$FILES" | tr ' ' '\n'

# Check if phpstan is executable
check_command_executable "$(command -v phpstan 2>/dev/null || echo './vendor/bin/phpstan')" "phpstan"

# Run PHPStan with specified level
phpstan analyse $FILES