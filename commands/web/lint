#!/bin/bash

set -euo pipefail

echo "üì¶ Reading changed files from .ddev"

PHP_CHANGED_FILES=$(cat .ddev/changed_php_files.txt 2>/dev/null | xargs || true)
JS_CHANGED_FILES=$(cat .ddev/changed_js_files.txt 2>/dev/null | xargs || true)
STYLE_CHANGED_FILES=$(cat .ddev/changed_css_files.txt 2>/dev/null | xargs || true)
TWIG_CHANGED_FILES=$(cat .ddev/changed_twig_files.txt 2>/dev/null | xargs || true)
TEXT_CHANGED_FILES=$(cat .ddev/changed_text_files.txt 2>/dev/null | xargs || true)

EXIT_CODE=0

echo "üîß Installing dependencies (Composer & Yarn)"
composer install --optimize-autoloader || { echo "‚ùå Composer install failed"; exit 1; }
yarn --modules-folder /var/www/html/node_modules --cwd /var/www/html/docroot/core/ install || { echo "‚ùå Yarn install failed"; exit 1; }

echo "üéØ Running linters..."

# PHP Linting
if [ -n "$PHP_CHANGED_FILES" ]; then
  echo "üßº PHP Linting on:"
  echo "$PHP_CHANGED_FILES" | tr ' ' '\n'
  echo "üîß Allowing PHPCS plugin..."
  composer config --no-interaction allow-plugins.dealerdirect/phpcodesniffer-composer-installer true || { echo "‚ùå Failed to allow PHPCS plugin"; exit 1; }

  echo "üì¶ Installing PHPCS-related packages..."
  composer require --dev drupal/coder dealerdirect/phpcodesniffer-composer-installer squizlabs/php_codesniffer || { echo "‚ùå Failed to install PHPCS packages"; exit 1; }

  if [ ! -f ./vendor/bin/phpcs ]; then
    echo "‚ùå PHPCS binary not found even after installation"
    exit 1
  fi
  ./vendor/bin/phpcs --version || EXIT_CODE=1
  ./vendor/bin/phpcs -- -s --colors --standard=Drupal --report-full --report-summary $PHP_CHANGED_FILES || EXIT_CODE=1
  ./vendor/bin/phpcs -- -s --colors --standard=DrupalPractice --report-full --report-summary $PHP_CHANGED_FILES || EXIT_CODE=1
else
  echo "‚úÖ No PHP files changed"
fi

# JS Linting
if [ -n "$JS_CHANGED_FILES" ]; then
  echo "üßº JS Linting on:"
  echo "$JS_CHANGED_FILES" | tr ' ' '\n'
  node ./node_modules/eslint/bin/eslint.js --version || EXIT_CODE=1
  node ./node_modules/eslint/bin/eslint.js --config=docroot/core/.eslintrc.json --no-eslintrc -f stylish --color $JS_CHANGED_FILES || EXIT_CODE=1
else
  echo "‚úÖ No JS files changed"
fi

# CSS Linting
if [ -n "$STYLE_CHANGED_FILES" ]; then
  echo "üßº CSS Linting on:"
  echo "$STYLE_CHANGED_FILES" | tr ' ' '\n'
  node ./node_modules/stylelint/bin/stylelint.mjs --version || EXIT_CODE=1
  node ./node_modules/stylelint/bin/stylelint.mjs --config ./.stylelintrc.json --color $STYLE_CHANGED_FILES || EXIT_CODE=1
else
  echo "‚úÖ No CSS files changed"
fi

# Twig Linting
if [ -n "$TWIG_CHANGED_FILES" ]; then
  echo "üßº Twig Linting on:"
  echo "$TWIG_CHANGED_FILES" | tr ' ' '\n'
  composer require --dev vincentlanglet/twig-cs-fixer || { echo "‚ùå Failed to install twig-cs-fixer"; exit 1; }
  ./vendor/bin/twig-cs-fixer --version || EXIT_CODE=1
  ./vendor/bin/twig-cs-fixer lint $TWIG_CHANGED_FILES || EXIT_CODE=1
else
  echo "‚úÖ No Twig files changed"
fi

# Spell Checking
if [ -n "$TEXT_CHANGED_FILES" ]; then
  echo "üìî Spell Checking on:"
  echo "$TEXT_CHANGED_FILES" | tr ' ' '\n'
  node ./node_modules/cspell/bin.mjs --version || EXIT_CODE=1
  node ./node_modules/cspell/bin.mjs --config .cspell.json --color $TEXT_CHANGED_FILES || EXIT_CODE=1
else
  echo "‚úÖ No text/code files changed for spell checking"
fi

echo "‚úÖ Linting finished"
exit $EXIT_CODE
