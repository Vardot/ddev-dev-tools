#!/bin/bash

## #ddev-generated
# Exit on errors and undefined variables
set -euo pipefail

## Description: Install Drupal using existing configuration
## Usage: install-drupal

echo "ğŸ› ï¸ Installing Drupal..."
ddev composer install --optimize-autoloader

echo "ğŸ“¥ Importing Database..."
# Check if the database file exists
if [ "${IS_CI:-false}" = "TRUE" ]; then
    echo "Running in CI environment"
    ddev drush sql-drop -y
    ddev import-db --file=./backups/thin-db.sql.gz
    ddev drush cr
else
    if [ -d ./backups ]; then
        ddev drush sql-drop -y
        # Find all .sql.gz files in the backups directory
        mapfile -t db_files < <(find ./backups -maxdepth 1 -type f -name "*.sql.gz")
        if [ ${#db_files[@]} -eq 0 ]; then
            echo "ğŸ“¥ No database backup files found!"
            exit 1
        elif [ ${#db_files[@]} -eq 1 ]; then
            selected_db="${db_files[0]}"
            echo "ğŸ“¥ Found one backup: $selected_db"
        else
            echo "Multiple database backups found:"
            select selected_db in "${db_files[@]}"; do
            if [ -n "$selected_db" ]; then
                break
            else
                echo "Invalid selection."
            fi
            done
        fi
        ddev import-db --file="$selected_db"
        ddev drush cr
    else
        echo "ğŸ“¥ Database backup not found!"
        exit 1
    fi
fi

echo "ğŸ“¦ Updating Database..."
ddev drush updb -y

echo "âš™ï¸ Importing Configuration..."
ddev drush cim -y
ddev drush cr

# Uninstall modules only if they are installed (enabled or disabled)
uninstall_if_enabled() {
  local module
  for module in "$@"; do
    if ddev drush pm:list --type=module --status=enabled,disabled --format=list | grep -Fxq "$module"; then
      echo "Disabling/uninstalling module: $module"
      # Do not fail the script if uninstall reports "not installed"
      ddev drush pm:uninstall "$module" -y || {
        echo "Module '$module' could not be uninstalled (likely not installed). Continuing."
      }
    else
      echo "Module '$module' not installed; skipping."
    fi
  done
}

echo "âš™ï¸  Disabling Captcha & Login destination modules"
uninstall_if_enabled captcha login_destination honeypot

# Check if cypress_test_content module exists in the filesystem.
echo "ğŸ” Checking for cypress_test_content module in filesystem..."

# Define possible module paths and info file extensions.
MODULE_PATHS=(
    "docroot/modules/custom/cypress_test_content"
    "web/modules/custom/cypress_test_content"
    "modules/custom/cypress_test_content"
    "docroot/sites/all/modules/custom/cypress_test_content"
    "sites/all/modules/custom/cypress_test_content"
)

MODULE_FOUND=false
MODULE_LOCATION=""

for path in "${MODULE_PATHS[@]}"; do
    if [ -f "${path}/cypress_test_content.info.yml" ] || [ -f "${path}/cypress_test_content.info" ]; then
        MODULE_FOUND=true
        MODULE_LOCATION="$path"
        break
    fi
done

if [ "$MODULE_FOUND" = true ]; then
    echo "âœ… cypress_test_content module found at: $MODULE_LOCATION"
    # Write the environment variable to a file for pipeline access
    echo "export CYPRESS_TEST_CONTENT_AVAILABLE=true" > .cypress_test_content_status
    ddev drush pm:enable cypress_test_content -y
else
    echo "âŒ cypress_test_content module not found in filesystem"
    # Write the environment variable to a file for pipeline access
    echo "export CYPRESS_TEST_CONTENT_AVAILABLE=false" > .cypress_test_content_status
fi

echo "ğŸ‘¤ Creating site admin user..."
admin_user="admin"
ddev drush user:create "$admin_user" --mail="admin@example.com" --password="password"
# Check if 'site_admin' role exists
if ddev drush role:list | grep -q '^site_admin'; then
    ddev drush user:role:add "site_admin" "$admin_user"
else
    # Find any role containing 'admin'
    admin_roles=$(ddev drush role:list | grep 'admin' | awk '{print $1}')
    if [ -n "$admin_roles" ]; then
        for role in $admin_roles; do
            ddev drush user:role:add "$role" "$admin_user"
        done
    else
        echo "No 'admin' roles found to assign to $admin_user."
    fi
fi

echo "âœ… Installation Complete!"
